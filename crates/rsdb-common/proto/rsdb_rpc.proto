syntax = "proto3";

package rsdb.rpc;

service CoordinatorControl {
  rpc RegisterWorker(RegisterWorkerRequest) returns (RegisterWorkerResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc ListWorkers(ListWorkersRequest) returns (ListWorkersResponse);
  rpc GetRegisteredTables(GetRegisteredTablesRequest) returns (GetRegisteredTablesResponse);
}

service WorkerTask {
  rpc ExecuteSql(ExecuteSqlRequest) returns (ExecuteSqlResponse);
  rpc ExecutePlanFragment(ExecutePlanFragmentRequest) returns (ExecutePlanFragmentResponse);
  rpc RegisterCsv(RegisterCsvRequest) returns (RegisterCsvResponse);
  rpc RegisterParquet(RegisterParquetRequest) returns (RegisterParquetResponse);
  rpc ListTables(ListTablesRequest) returns (ListTablesResponse);
}

message RegisterWorkerRequest {
  uint32 node_id = 1;
  string addr = 2;
}

message RegisterWorkerResponse {}

message HeartbeatRequest {
  uint32 node_id = 1;
}

message HeartbeatResponse {}

message ListWorkersRequest {}

message Worker {
  uint32 node_id = 1;
  string addr = 2;
  int64 registered_at_unix_ms = 3;
  int64 last_heartbeat_unix_ms = 4;
  string status = 5;
}

message ListWorkersResponse {
  repeated Worker workers = 1;
}

message ExecuteSqlRequest {
  string sql = 1;
}

// Arrow IPC stream bytes (StreamWriter format)
message ExecuteSqlResponse {
  bytes arrow_ipc = 1;
}

message ExecutePlanFragmentRequest {
  // Substrait plan bytes (prost-encoded Plan)
  bytes plan_bytes = 1;
}

message ExecutePlanFragmentResponse {
  // Arrow IPC stream bytes (StreamWriter format)
  bytes arrow_ipc = 1;
}

message RegisterCsvRequest {
  string table_name = 1;
  string path = 2;
  bool has_header = 3;
  uint32 delimiter = 4;
}

message RegisterCsvResponse {}

message RegisterParquetRequest {
  string table_name = 1;
  string path = 2;
}

message RegisterParquetResponse {}

message ListTablesRequest {}

message ListTablesResponse {
  repeated string table_names = 1;
}

message GetRegisteredTablesRequest {}

message RegisteredTable {
  string table_name = 1;
  string kind = 2;
  string path = 3;
  bool has_header = 4;
  uint32 delimiter = 5;
}

message GetRegisteredTablesResponse {
  repeated RegisteredTable tables = 1;
}
